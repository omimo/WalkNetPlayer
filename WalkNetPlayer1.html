<!DOCTYPE html>
<!-- WebGl Mocap Player - V 0.2 
By Omid Alemi
 -->
<html lang="en">

<head>
	<title>WalkNet Player</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<link rel="stylesheet" href="style/pace.css"></link>
	<link rel="stylesheet" href="bower_components/material-design-lite/material.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<!--<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.light_blue-blue.min.css" />-->
	<!--<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.amber-orange.min.css" />	-->
	<!--<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.brown-orange.min.css" />-->
	<!--<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.cyan-indigo.min.css" />-->
	<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.blue_grey-orange.min.css" />
	<link rel="stylesheet" href="style/main.css" />

	<script src="bower_components/pace/pace.min.js"></script>
	<script src="bower_components/mathjs/dist/math.min.js"></script>
	<script src="bower_components/jquery/dist/jquery.min.js"></script>
	<script src="bower_components/three.js/build/three.min.js"></script>
	<script src="bower_components/three.js/examples/js/controls/OrbitControls.js"></script>
	<script src="bower_components/WebHamsters/src/hamsters.min.js"></script>
	<script src="bower_components/material-design-lite/material.min.js"></script>

	<script src="js/jsMocapGL.js"></script>
	<script src="js/skeletonFactory.js"></script>
</head>

<body>
	<script>
		var scene, camera, renderer,
			lights = [],
			characters = [];


		$(document).ready(function() {
			init();

			animate();

			$(window).on("resize", function(e) {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize($('#player').width(), window.innerHeight * 0.7);
			});

			$('#btnConnect').on("click", function(e) {

				var url = 'ws://' + $('#txtServerIP')[0].value + ':' + $('#txtServerPort')[0].value;
				c2.loadFromStream(url, function() {
					scene.add(c2.skeleton);

					var data = {
						message: 'Connected to ' + url
					};
					document.querySelector('#notification').MaterialSnackbar.showSnackbar(data);
				});
			});

			$('#btnStart').on('click', function(e) {
				if (c2.webSocket.readyState == 1) {
					c2.webSocket.send('$CMD$START$');
				}
			});

			$('#btnStop').on('click', function(e) {
				if (c2.webSocket.readyState == 1) {
					c2.webSocket.send('$CMD$STOP$');
				}
			});

			$('#sldrDirection').on('change', sendLabels);
			$('#sldrPerformer').on('change', sendLabels);
			$('#sldrValence').on('change', sendLabels);
			$('#sldrArousal').on('change', sendLabels);

		});

		function sendLabels() {
			var p = [];
			p.directionR = (parseInt($('#sldrDirection')[0].value) + 10) / 20;
			p.directionL = 1 - p.directionR;
			p.per1 = parseInt($('#sldrPerformer')[0].value) / 10;
			p.per2 = 1 - p.per1;
			p.valence = parseInt($('#sldrValence')[0].value) / 10;
			p.arousal = parseInt($('#sldrArousal')[0].value) / 10;

			console.log(p);

			paramMsg = '$PAR$';
			paramMsg += p.directionR + '$';
			paramMsg += p.directionL + '$';
			paramMsg += p.per1 + '$';
			paramMsg += p.per2 + '$';
			paramMsg += p.valence + '$';
			paramMsg += p.arousal + '$';

			if (c2.webSocket.readyState == 1) {
				c2.webSocket.send(paramMsg);
			}
		}


		function set_the_scene() {
			// Lights

			lights[0] = new THREE.PointLight(0xffffff, 1, 0);
			lights[0].position.set(0, 100, 0);

			scene.add(lights[0]);

			// Grid
			var size = 2000,
				step = 20;

			var geometry = new THREE.PlaneGeometry(size * 2, size * 2);
			var material = new THREE.MeshPhongMaterial({
				color: 0x444444,
				emissive: 0x000000,
				specular: 0x111111,
				side: THREE.DoubleSide,
				transparent: true,
				opacity: 0.9
			});
			var plane = new THREE.Mesh(geometry, material);
			plane.position.set(0, 0, 0);
			plane.rotation.set(math.pi / 2, 0, 0);
			scene.add(plane);

			var geometry = new THREE.Geometry();
			var material = new THREE.LineBasicMaterial({
				color: 0x555555,
				linewidth: 1.2
			});
			for (var i = -size; i <= size; i += step) {
				geometry.vertices.push(new THREE.Vector3(-size, -0.04, i));
				geometry.vertices.push(new THREE.Vector3(size, -0.04, i));
				geometry.vertices.push(new THREE.Vector3(i, -0.04, -size));
				geometry.vertices.push(new THREE.Vector3(i, -0.04, size));
			}

			var line = new THREE.LineSegments(geometry, material);
			scene.add(line);

		}

		function init() {
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 10, 4000);
			camera.position.set(0, 80, 0);
			camera.position.z = 350;
			scene.add(camera);

			set_the_scene();

			c2 = new BVHCharacter("Gholi", jointmaterial, bonematerial, makeJointGeometry_Dode, makeBoneGeometry_Cylinder2);
			c2.skelScale = 1.1;
			c2.setOriginPosition(0, 38, 0); //TODO: Fix the height

			characters.push(c2);


			renderer = new THREE.WebGLRenderer({
				antialias: true
			});
			renderer.setSize($('#player').width(), window.innerHeight * 0.7);
			renderer.gammaInput = true;
			renderer.gammaOutput = true;
			renderer.setPixelRatio(window.devicePixelRatio);


			renderer.setClearColor(0xefefef, 0.8);
			renderer.setClearColor(0xffffff, 1);
			document.getElementById('player').appendChild(renderer.domElement);

			controls = new THREE.OrbitControls(camera, renderer.domElement);
		}

		function animate() {
			requestAnimationFrame(animate);

			characters.forEach(function(c) {
				if (1 && c.ready) {
					if (c.playing) {
						c.animIndex = c.animOffset + Math.floor((Date.now() - c.animStartTimeRef) / c.frameTime / 1000);

						if (c.animIndex >= c.frameCount) {
							c.playing = false;
							console.log("Stopped");
						}
						c.animFrame(c.animIndex);


						cx = c.jointMeshes[0].matrixWorld.elements[12];
						cy = c.jointMeshes[0].matrixWorld.elements[13];
						cz = c.jointMeshes[0].matrixWorld.elements[14];

						camera.position.set(cx, cy + 20, cz + 200);
						camera.lookAt(cx, cy - 120, cz - 20);

						lights[0].position.set(cx, cy + 200, cz);
					}
				}
			});

			renderer.render(scene, camera);
		}
	</script>

	<!--Header-->
	<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
		<header class="mdl-layout__header">
			<div class="mdl-layout__header-row">
				<!-- Title -->
				<span class="mdl-layout-title">WalkNet Player</span>
				<!-- Add spacer, to align navigation to the right -->
				<div class="mdl-layout-spacer"></div>
				<!-- Navigation. We hide it in small screens. -->
				<!--<nav class="mdl-navigation mdl-layout--large-screen-only">
        <a class="mdl-navigation__link" href="">Link</a>
        <a class="mdl-navigation__link" href="">Link</a>
        <a class="mdl-navigation__link" href="">Link</a>
        <a class="mdl-navigation__link" href="">Link</a>
      </nav>-->
			</div>
		</header>


		<!--Main Components-->

		<div class="mdl-grid">
			<div id="player" class="mdl-cell mdl-cell--9-col mdl-color--white mdl-shadow--4dp">

			</div>

			<div id="sidebar" class="mdl-grid mdl-cell mdl-cell--3-col mdl-grid--no-spacing">

				<!--Generation Controller-->
				<div id="controller" class="mdl-grid mdl-cell mdl-cell--3-col mdl-cell--3-col mdl-cell--3-col-tablet mdl-cell--12-col-desktop mdl-color--white mdl-shadow--4dp">
					<div class='title'> Generation Controller </div>

					<div class="control">
						<label for="modelSelector">WalkNet Model</label>
						<div class="select">
							<select id="modelSelector">
            <option value="walknet1">walknet1</option>       
          </select>
						</div>
					</div>


					<div id='agentButtons' class="control">
						<button id="btnStart" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored">
					<i class="material-icons">play_arrow</i>
					</button>
						<div class="mdl-tooltip" for="btnStart">
							Start the Agent
						</div>

						<button id="btnStop" class="mdl-button mdl-js-button mdl-button--icon" ">
					<i class="material-icons ">stop</i>
				</button>
					<div class="mdl-tooltip " for="btnStop ">
						Stop the Agent
					</div>
					</div>
					
				</div>
				
				<div class="mdl-cell--1-col " style="height: 32px; "></div>

				<!--Agent Parameters-->
				<div id="agentParam " class="mdl-grid mdl-cell mdl-cell--3-col mdl-cell--3-col mdl-cell--3-col-tablet mdl-cell--12-col-desktop mdl-color--white mdl-shadow--4dp ">

					<div class='title'> Agent Parameters </div>

					
					<p>
						<div style='height: 32px;'></div>
					</p>

					<p style="width:90% ">
						
						<label for="sldrDirection ">Direction</label>
						<input class="mdl-slider mdl-js-slider " type="range" id="sldrDirection" min="-10" max="10" value="0" step="0.01">
					</p>

					<p style="width:90% ">
						<label for="sldrPerformer ">Performer</label>
						<input class="mdl-slider mdl-js-slider " type="range" id="sldrPerformer" min="0" max="10" value="0" step="0.01">
					</p>

					<p style="width:90% ">
						<label for="sldrValence ">Valence</label>
						<input class="mdl-slider mdl-js-slider " type="range" id="sldrValence" min="5" max="35" value="20" step="0.01">
					</p>

					<p style="width:90% ">
						<label for="sldrArousal ">Arousal</label>
						<input class="mdl-slider mdl-js-slider " type="range" id="sldrArousal" min="5" max="35" value="20" step="0.01">
					</p>



				</div>

				<div class="mdl-cell--1-col " style="height: 32px; "></div>

				<div id="options " class="mdl-grid mdl-cell mdl-cell--3-col mdl-cell--3-col mdl-cell--3-col-tablet mdl-cell--12-col-desktop mdl-color--white mdl-shadow--4dp ">


					<!-- Server Config -->
					<div class="title "> Options </div>
					<div style="width:90%;">
						<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label ">
							<input class="mdl-textfield__input " type="text " id="txtServerIP " value="127.0.0.1 ">
							<label class="mdl-textfield__label " for="txtServerIP ">Server Address</label>
						</div>

						<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label ">
							<input class="mdl-textfield__input " type="text " id="txtServerPort " value="7072 ">
							<label class="mdl-textfield__label " for="txtServerPort ">Server Port</label>
						</div>

						<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored " id="btnConnect ">
  							Connect
						</button>

					</div>
				</div>
			</div>

			<!--Activations Tab-->
			<div id="activations " class="mdl-cell mdl-cell--bottom mdl-cell--9-col mdl-color--white mdl-shadow--4dp "> Activations </div>



			<div id="notification " class="mdl-js-snackbar mdl-snackbar ">
				<div class="mdl-snackbar__text "></div>
				<button class="mdl-snackbar__action " type="button "></button>
			</div>


			<!--Footer-->
			<footer class="mdl-mini-footer " style="width: 100%; ">
				<div class="mdl-mini-footer__left-section ">
					<div class="mdl-logo ">
						(c) 2016 - Omid Alemi
					</div>
					<ul class="mdl-mini-footer__link-list ">
						<li><a href="# ">Help</a></li>
						<li><a href="# ">Paper</a></li>
					</ul>
				</div>
				<div class="mdl-mini-footer__right-section ">
					<button class="mdl-mini-footer__social-btn "></button>
					<button class="mdl-mini-footer__social-btn "></button>
					<button class="mdl-mini-footer__social-btn ">Github</button>
				</div>
			</footer>

</body>

</html>